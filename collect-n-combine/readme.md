# collect-n-combine

This directory mainly contains the code for dependency collection and dependency combination.
Its input is the meta information (json files) extracted from the headers, binaries of the target SDK, and the traces recorded from the consumer programs (using the tools in `preprocessing`).
And its output is the generated candidate fuzzer drivers (harnesses).

Generally, it first identifies the data and control dependencies from the meta information and traces (`collect.sh` as entry points). 
Then it combines the collected dependencies (`combine.sh` as entry points).

# Usage

## Prerequisite

### Python dependency

```bash
# for linux
pip install graphviz
# for mac
brew install graphviz
```

### Configuration

For a given attack surface, you need to configure before running, see examples in `cfgs/attack_surface_name`.

- `cfgs/attack_surface_name/cfgs/xxx.toml`, configurations for setting up the dynamic coverage collection, harness generation template, and the knowledge base
- `cfgs/attack_surface_name/funcs/xxx`, list of target apis
- `cfgs/attack_surface_name/relations/xxx`, path of relation files generated by running `collect.sh`
- `cfgs/attack_surface_name/traces/xxx`, path of trace files used as inputs for `collect.sh`
- `cfgs/attack_surface_name/env`, path of meta information json files for the header analysis and the binary `bb_offset` analysis

### Fix the traces

Before running everything, APICraft needs to recognize the output parameters from the traces and patches the traces accordingly.
(This is an ugly implementaion and ideally this can be automated, we plan to fix it later.)

```
# configure the variables in extra_out.py line 25, 28
python extra_out.py
# the fixed traces are new files named as ${trace_file_name}_fixed
```

## Steps

Run the following command for collecting the dependencies.

```bash
bash collect.sh
```

Run the following command for combining the dependencies.

```bash
bash combine.sh
```

